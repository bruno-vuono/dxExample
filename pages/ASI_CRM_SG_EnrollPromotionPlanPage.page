<!--
*********************************************************************************
 * Name: ASI_CRM_SG_EnrollPromotionPlanPage
 * Description: Provide enrollment function for Sales User to enroll Promotion Plan
 *
 * Version History
 * Date             Developer               Comments
 * ---------------  --------------------    --------------------------------------------------------------------------------
 * 27/03/2018       Hugo Cheung             Created    
-->
<apex:page standardController="ASI_HK_CRM_Promotion__c" extensions="ASI_CRM_SG_EnrollPromotionPlanCtrl">
    <!-- Import Library -->
    <!-- CSS -->
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/main.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/jquery-ui.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/bootstrap.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/datatables.min.css')}" />
    <!-- JavaScript -->
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/bootstrap.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/datatables.min.js')}" />
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    
    <!-- Style -->
    <style>
        body {font-size:12px}
        .link-button {
            cursor: pointer;
            text-decoration: underline;
        }
        
        .savingRecord .fullScreenLoading{
            display : block;
        }

        .fullScreenLoading {
            display    : none;
            position   : fixed;
            z-index    : 1000;
            top        : 0;
            left       : 0;
            height     : 100%;
            width      : 100%;
            background : rgba( 255, 255, 255, .8 ) 
                         url('{!URLFOR($Resource.ASI_CRM_SG_Library, '/images/loading.gif')}')  
                         50% 50% 
                         no-repeat;
        }

        .error {
            border: 2px solid red;
        }
        
        th, td {
                padding-top    : 5px;
                padding-bottom : 5px;
                padding-right  : 7px;
                padding-left   : 7px;
            }
            
        table { 
        }
        
        <!-- Datatable Styling -->
        table.dataTable td {
            height : 30px;
        }
        
        table.dataTable thead tr {
            background-color : #cce6ff;
        }
    
        table.dataTable tbody tr { 
            background-color : #e6f3ff; 
        }
        
        table.dataTable tbody tr:nth-child(even) {
            background-color : white;  
        }
        
        table.dataTable td { 
            border-bottom : 2px solid #e0e0d1; 
        }
		
		.inputField_short {
			width: 50px;
		}

		.inputField_medium {
			width: 75px;
		}

		.inputField_long {
			width: 250px;
		}
		
		.alignRight {
			text-align: right;
		}
    </style>
    
    <!-- JavaScript -->
    <script>
        /****************
        Define Variable
        ****************/
        const numFormater = new Intl.NumberFormat();
        
        const ACTION_LABEL                   = 'Action';
        const NEW_PROMOTION_DETAIL_PREFIX    = 'Promotion_Detail_';
        const PROMOTION_DETAIL_TABLE_PREFIX  = 'promotionDetailTable_';
        const PROMOTION_CUSTOMER_PREFIX      = 'promotionCustomer_';
        
		const CONST_DATA_TABLE_PROPERTIES    = {
            "bDestroy":true,
            "bStateSave":true,
            "bSearch":false,
            "bFilter" : false,
            "iDisplayLength":1000,
            "bSort" : false,
            "bPaginate": false,
            "bScrollCollapse": true,
            "bJQueryUI": true
        };
        
        const PROMOTION_ID = '{!promotion.Id}';
        const PROMOTION_NUMBEROFMONTH = {!promotion.ASI_CRM_Promotion_Plan__r.ASI_CRM_Promotion_Period_Month__c};
        const PROMOTION_DETAIL_RECORD_TYPE_ID = '{!promotionDetailRecordTypeId}';
        const PROMOTION_MECHANIC_LIST = jQuery.parseJSON('{!JSENCODE(promotionMechanicListJson)}');
		const AFTER_ENROLLMENTCUTOFFDATE = '{!promotion.ASI_CRM_Promotion_Plan__r.ASI_CRM_Start_Date__c < TODAY()}' == 'true';
		const READ_ONLY = '{!isReadOnly}' == 'true';
		const ADJUST_TARGET_ONLY = '{!adjustTargetOnly}' == 'true';
		const IS_FINAL_APPROVED = "{!promotion.ASI_HK_CRM_Status__c = 'Final Approved'}" == 'true';
        
        //Auto Complete Value
        var CUSTOMER_LIST = jQuery.parseJSON('{!JSENCODE(customerListJson)}');
        const CUSTOMER_MAP = jQuery.parseJSON('{!JSENCODE(customerMapJson)}');
		const PARENT = 'Parent: ';
        
        //Outlet Panel HTML Code
        const OUTLET_PANEL_HTML = '<div class="panel panel-default outletPanel" id="{0}">'
                                + '<div class="panel-heading">'
                                + '<div class="container">'
                                + '<div class="col-sm-4 outletName">{1}</div>'
                                + '<div class="col-sm-4">{4}</div>'
                                + '<div class="col-sm-1"></div>'
                                + '<div class="col-sm-2"><input type="button" class="btn removeBtn" onclick="deleteOutlet(\'{2}\')" value="Remove" /></div>'
                                + '</div>'
                                + '</div>'
                                + '<div class="panel-body"><table id="{3}" width="100%" /></div>'
                                + '</div>';
        
        var NEW_PROMOTION_DETAIL_INDEX = 1;
        var NEW_PROMOTION_TABLE_ID_INDEX = 1;
        var deletePromotionDetailIdList  = [];
        
        /*****************
        Datatable Field Config
        *****************/
        const FIELD_CONFIG_MAPPING = {
            "ASI_CRM_Promotional_SKU__c"                : {"title"          : "Promotional SKU", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                                    			if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c) {
                                                                        			data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__r.Name;
                                                                        		} else {
                                                                        			data = "";
                                                                        		}
                                                     				
                                                     							return data;
                                                                              }
                                                          }, 
             
            "ASI_CRM_Additional_SKU_POSM__c"            : {"title"          : "Additional SKU <br /> / POSM", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                                    			if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_POSM__c) {
                                                                        			data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_POSM__r.Name;
                                                                        		} else {
                                                                        			data = "";
                                                                        		}
                                                     			
                                                     							return data;
                                                                              }
                                                          }, 
            
            "ASI_CRM_Gift_Voucher__c"                   : {"title"          : "Gift Voucher ($)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                                    			if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Gift_Voucher__c) {
                                                                        			data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Gift_Voucher__r.Name;
                                                                        		} else {
                                                                        			data = "";
                                                                        		}
                                                     			
                                                     							return data;
                                                                              }
                                                          },
            
            "ASI_CRM_Promotional_Sub_brand__c"          : {"title"          : "Promotional Sub-brand",
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                                    			if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c) {
                                                                        			data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__r.Name;
                                                                        		} else {
                                                                        			data = "";
                                                                        		}
                                                     			
                                                     							return data;
                                                                              }
                                                          },
            
            "ASI_CRM_Buy_Qty__c"                        : {"title"          : "Buy (Qty)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                          						if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Qty__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Qty__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
        							   											return data;
                                                                              }
                                                          },
            
            "ASI_CRM_Buy_Unit__c"                       : {"title"          : "Buy (Unit)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                          						if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Unit__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Unit__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                     		                  }
                                                          },
            
            "ASI_CRM_Trade_Deal_Bottle_Qty__c"          : {"title"          : "Trade Deal <br />(Bottle Qty)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                          						if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Trade_Deal_Bottle_Qty__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Trade_Deal_Bottle_Qty__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                                              } 
                                                          },
            
            "ASI_CRM_Additional_SKU_Bottle_Qty__c"      : {"title"          : "Additional SKU <br />(Bottle Qty)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                     							if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_Bottle_Qty__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_Bottle_Qty__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                                     	      }
                                                          },
            
            "ASI_CRM_Ad_hoc_Cash__c"                    : {"title"          : "Ad-hoc ($)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                     							if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Ad_hoc_Cash__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Ad_hoc_Cash__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                                     	      }
                                                          },
            
            "ASI_CRM_Other_in_Kind_Cash__c"             : {"title"          : "Other in Kind ($)", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                     							if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Other_in_Kind_Cash__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Other_in_Kind_Cash__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                                              }
                                                          }, 
            
            "ASI_CRM_Target_Qty_Bottle__c"              : {"title"          : "Target Qty <br /> (Bottle)", 
                                                           "data"           : "ASI_CRM_Target_Qty_Bottle__c",
                                                           "render"         : function(data, type, full) {
                                                     							var fieldAPIName = 'ASI_CRM_Target_Qty_Bottle__c';
																				
																				if(!data) {
                                                                            		data = "";
                                                                        	    }
                                                                       			if(READ_ONLY) return data;
                                                          						return "<input class='" + fieldAPIName + " numberField inputField_medium form-control' type='number' min='0' value='" + data + "' onChange='updatePromotionDetailValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                              }
                                                          },
                                                      
            "ASI_CRM_Target_Volume_9L__c"               : {"title"          : "Target Volume <br /> (9L)", 
                                                           "data"           : "ASI_CRM_Target_Volume_9L__c",
                                                           "render"         : function(data, type, full) {
                                                                       			var targetCase    = full.ASI_CRM_Target_Qty_Bottle__c ? full.ASI_CRM_Target_Qty_Bottle__c : 0;
																				var bottleSize    = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Bottle_Size_Promotional__c ? full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Bottle_Size_Promotional__c : 0;
																				var total         = targetCase * bottleSize / 900;
																				return total.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                              }
                                                          },
                                                      
            "ASI_CRM_Monthly_Avg_Target_Volume_9L__c"   : {"title"          : "Monthly Avg Target <br /> Volume (9L)", 
                                                           "data"           : "ASI_CRM_Monthly_Avg_Target_Volume_9L__c",
                                                           "render"         : function(data, type, full) {
                                                                       			var targetCase    = full.ASI_CRM_Target_Qty_Bottle__c ? full.ASI_CRM_Target_Qty_Bottle__c : 0;
																				var bottleSize    = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Bottle_Size_Promotional__c ? full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Bottle_Size_Promotional__c : 0;
																				var total         = targetCase * bottleSize / (900 * PROMOTION_NUMBEROFMONTH);
																				return total.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                               }
                                                          },
            
            "ASI_CRM_P12M_Avg_Consumption_9L__c"        : {"title"          : "P12M Avg <br /> Consumption (9L)", 
                                                           "data"           : "ASI_CRM_P12M_Avg_Consumption_9L__c",
                                                           "render"         : function(data, type, full) {
                                                                       		 	if(!data) {
                                                                            		data = "";
                                                                        	 	}
																				var total         = full.ASI_CRM_P12M_Avg_Consumption_9L__c;
                                                          						return total.toLocaleString('en-US', {minimumFractionDigits: 4});
                                                                               }
                                                          }, 
            
            "ASI_CRM_Remark__c"                         : {"title"          : "Remark", 
                                                           "data"           : "ASI_CRM_Remark__c",
                                                           "render"         : function(data, type, full) {
                                                     							if(full.ASI_CRM_Promotion_Mechanic__r && 
                                                                                   full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Remark__c) {
                                                                                	data = full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Remark__c;
                                                                            	} else {
                                                                            		data = "";
                                                                        		}
                                                          						return data;
                                                                              }
                                                          },
														  
            "mechanics"                                 : {"title"          : "Mechanic", 
                                                           "data"           : "",
                                                           "render"         : function(data, type, full) {
                                                     							return full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Mechanic_Description__c;
																				/*
																				var s = "";
																				if(full.ASI_CRM_Promotion_Mechanic__r) {
                                                                                	s = "Buy every ";
																					s += full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Qty__c + " " 
																						+ full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Buy_Unit__c + " of ";
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c){
																						s += "Sub-brand <b>" + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__r.Name + "</b> ";
																					} else
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c){
																						s += "SKU <b>" + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__r.Name + "</b> ";
																					}
																					s += "Give:<br/>";
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Trade_Deal_Bottle_Qty__c){
																						s += "- " + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Trade_Deal_Bottle_Qty__c + " bottles of "
																							+ full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__r.Name + "<br/>";
																					}
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_Bottle_Qty__c){
																						s += "- " + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_Bottle_Qty__c + " bottles of " 
																							+ full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Additional_SKU_POSM__r.Name + "<br/>";
																					}
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Ad_hoc_Cash__c){
																						s += "- Ad-hoc $" + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Ad_hoc_Cash__c + "<br/>";
																					}
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Gift_Voucher__c){
																						s += "- Voucher " + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Gift_Voucher__r.Name + "<br/>";
																					}
																					if(full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Other_in_Kind_Cash__c){
																						s += "- Other in Kind $" + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Other_in_Kind_Cash__c 
																							+ " (" + full.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Remark__c + ")<br/>";
																					}
                                                                            	}
                                                          						return s;
																				*/
                                                                              }
                                                          },
            
            "ASI_CRM_ActualConsumption_9L__c"           : {"title"          : "Actual Consumption<br/>within Promotion (9L)",
                                                           "data"           : "ASI_CRM_ActualConsumption_9L__c",
                                                           "render"         : function(data, type, full) {
                                                                    			if(!data) {
                                                                            		data = "";
                                                                        	 	}
																				var total         = full.ASI_CRM_ActualConsumption_9L__c;
                                                          						return total.toLocaleString('en-US', {minimumFractionDigits: 4});
                                                                              }
                                                          },
        };
        
        /****************
        Define Standard Function
        ****************/
        $(document).ready(
        	function() {
                initCustomFunction();
        		setTable('{!JSENCODE(promotionDetailListJson)}');
				if(READ_ONLY || ADJUST_TARGET_ONLY || AFTER_ENROLLMENTCUTOFFDATE) $('#addOutletName').hide();
				if(READ_ONLY) $('.btn').hide(); 
				if(ADJUST_TARGET_ONLY) $('.removeBtn').hide(); 
				if(AFTER_ENROLLMENTCUTOFFDATE) $('.removeBtn').hide(); 
                $("#warningPanel").hide();
        	}
        );
        
        function initCustomFunction() {
        	String.prototype.format = String.prototype.f = function() {
            	var s = this;
               	var i = arguments.length;

                while (i--) {
                    s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
                }
                return s;
            };
        }
        
        //Set Data Table
        function setTable(promotionDetailListJson) {
        	$(".outletPanel").remove();
			var promotionDetailList = jQuery.parseJSON(promotionDetailListJson);
            
        	var outletPromotionDetailListMap = {};
            for(var index = 0 ; index < promotionDetailList.length; index++) {
                var tempPromotionDetailList = [];

                if(promotionDetailList[index].ASI_CRM_SG_Customer__r.Name in outletPromotionDetailListMap) 
                    tempPromotionDetailList = outletPromotionDetailListMap[promotionDetailList[index].ASI_CRM_SG_Customer__r.Name];
                
                tempPromotionDetailList.push(promotionDetailList[index]);
                outletPromotionDetailListMap[promotionDetailList[index].ASI_CRM_SG_Customer__r.Name] = tempPromotionDetailList;
            }
            
            for(var outletName in outletPromotionDetailListMap) {
                var index = CUSTOMER_LIST.indexOf(outletName);
				if (index > -1) {
				  CUSTOMER_LIST.splice(index, 1);
				}
				var sectionId = PROMOTION_CUSTOMER_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
				var tableId = PROMOTION_DETAIL_TABLE_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
                var parentOutletName = CUSTOMER_MAP[outletName] && CUSTOMER_MAP[outletName].ASI_CRM_CN_Parent_Outlet__r != null 
                                     ? PARENT + CUSTOMER_MAP[outletName].ASI_CRM_CN_Parent_Outlet__r.Name 
                                     : '';
				var promotionDetailBody = OUTLET_PANEL_HTML.f(sectionId, outletName, sectionId, tableId, parentOutletName);
                $("#promotionEnrollmentForm").append(promotionDetailBody);
                
                setNewTableConfig(tableId, outletPromotionDetailListMap[outletName]);
                
                NEW_PROMOTION_TABLE_ID_INDEX ++;
            }
            
            initAutoComplete();
            preventNagativeNumber();
        }

        // when user types in input#addOutletName, search result and add outlet on click
        function initAutoComplete() {
        	$("#addOutletName").each(function(index) {
                $(this).autocomplete({
                    source    : CUSTOMER_LIST,
                    minLength : 3,
					select    : function(event, ui){	
						event.preventDefault();	
						var outletName = ui.item.value;
						addOutlet(outletName);
						$(this).val('');
					}
                });
            });
        }
        
        function addOutlet(outletName) {
            //var outletName = $('#addOutletName').val();
			var index = CUSTOMER_LIST.indexOf(outletName);
			if (index > -1) {
			  CUSTOMER_LIST.splice(index, 1);
			}
			
			var addedPromotionDetailList = [];
            for(var index = 0 ; index < PROMOTION_MECHANIC_LIST.length ; index++) {
                var promotionDetail = {};
                promotionDetail.Id                            = NEW_PROMOTION_DETAIL_PREFIX + NEW_PROMOTION_DETAIL_INDEX;
                promotionDetail.ASI_CRM_Promotion_Mechanic__r = PROMOTION_MECHANIC_LIST[index];
                promotionDetail.ASI_CRM_Promotion_Mechanic__c = PROMOTION_MECHANIC_LIST[index].Id;
                promotionDetail.ASI_CRM_SG_Customer__c        = outletName;
				promotionDetail.ASI_HK_CRM_Promotion__c       = PROMOTION_ID;
				promotionDetail.RecordTypeId                  = PROMOTION_DETAIL_RECORD_TYPE_ID;


                NEW_PROMOTION_DETAIL_INDEX ++;
                addedPromotionDetailList.push(promotionDetail);
            }


            var skuIds = addedPromotionDetailList.map(detail => detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c);
            var subBrandIds = addedPromotionDetailList.map(detail => detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c);
			
            var promotionPlanRT = '{!promotion.ASI_CRM_Promotion_Plan__r.RecordType.DeveloperName}';

            $("body").addClass("savingRecord");
			
            if(promotionPlanRT.includes('ASI_CRM_SG_Outlet_Promotion_Plan')){
				getAllRelatedOfftakes(
					outletName,
					JSON.stringify(skuIds),
					JSON.stringify(subBrandIds),
					JSON.stringify(addedPromotionDetailList)
				);
            }

            if(promotionPlanRT.includes('ASI_CRM_SG_Wholesaler_Promotion_Plan')){
                getAllRelatedSalesOrderHistories(
					outletName,
					JSON.stringify(skuIds),
					JSON.stringify(subBrandIds),
					JSON.stringify(addedPromotionDetailList)
				);
            }



            // var sectionId = PROMOTION_CUSTOMER_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
            // var tableId = PROMOTION_DETAIL_TABLE_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
            // var promotionDetailBody = OUTLET_PANEL_HTML.f(sectionId, outletName, sectionId, tableId);
            // $("#promotionEnrollmentForm").append(promotionDetailBody);
            // setNewTableConfig(tableId, addedPromotionDetailList);
            // NEW_PROMOTION_TABLE_ID_INDEX ++;
        }
		
		
        function addOutletComplete_offtake(addedPromotionDetailListJson, outletName, resultJson) {
			var addedPromotionDetailList = jQuery.parseJSON(addedPromotionDetailListJson);
			var result = jQuery.parseJSON(resultJson);
            
            const reducer = (accumulator, currentValue) => accumulator + currentValue;
			
        	addedPromotionDetailList.forEach(detail => {
				let relatedOfftakes = result.filter(offtake =>
					(detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c ?
						(offtake.ASI_CRM_SKU__r.ASI_MFM_Sub_brand__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c) :
						(offtake.ASI_CRM_SKU__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c)
					)&&
					new Date(offtake.ASI_TH_CRM_Offtake_G_L_Date__c) >= new Date('{!lastYearSameMonthStart}')
				);

				let hasOfftakeBefore = result.some(offtake =>
					(detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c ?
						(offtake.ASI_CRM_SKU__r.ASI_MFM_Sub_brand__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c) :
						(offtake.ASI_CRM_SKU__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c)
					)&&
					new Date(offtake.ASI_TH_CRM_Offtake_G_L_Date__c) <= new Date('{!lastYearSameMonthStart}'));
				let months = relatedOfftakes.map(offtake => new Date(offtake.ASI_TH_CRM_Offtake_G_L_Date__c).getMonth());
				let monthsSet = new Set(months);
				let numOfMonth = hasOfftakeBefore ? 12 : monthsSet.size;

				let sum = relatedOfftakes.map(offtake => offtake.ASI_CRM_Converted_Qty_9L__c).reduce(reducer, 0);

				detail.ASI_CRM_P12M_Avg_Consumption_9L__c = numOfMonth === 0 ? 0 : sum / numOfMonth;

			})
			addOutletComplete_final(addedPromotionDetailList, outletName);
        }
		
        function addOutletComplete_SOH(addedPromotionDetailListJson, outletName, resultJson) {
			var addedPromotionDetailList = jQuery.parseJSON(addedPromotionDetailListJson);
			var result = jQuery.parseJSON(resultJson);
            
            const reducer = (accumulator, currentValue) => accumulator + currentValue;
			
        	addedPromotionDetailList.forEach(detail => {
				let relatedOfftakes = result.filter(offtake =>
					(detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c ?
						(offtake.ASI_HK_CRM_Product_SKU__r.ASI_MFM_Sub_brand__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c) :
						(offtake.ASI_HK_CRM_Product_SKU__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c)
					)&&
					new Date(offtake.ASI_HK_CRM_Sales_Order_History__r.ASI_HK_CRM_Order_Date__c) >= new Date('{!lastYearSameMonthStart}')
				);

				let hasOfftakeBefore = result.some(offtake =>
					(detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c ?
						(offtake.ASI_HK_CRM_Product_SKU__r.ASI_MFM_Sub_brand__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_Sub_brand__c) :
						(offtake.ASI_HK_CRM_Product_SKU__c == detail.ASI_CRM_Promotion_Mechanic__r.ASI_CRM_Promotional_SKU__c)
					)&&
					new Date(offtake.ASI_HK_CRM_Sales_Order_History__r.ASI_HK_CRM_Order_Date__c) <= new Date('{!lastYearSameMonthStart}'));
				let months = relatedOfftakes.map(offtake => new Date(offtake.ASI_HK_CRM_Sales_Order_History__r.ASI_HK_CRM_Order_Date__c).getMonth());
				let monthsSet = new Set(months);
				let numOfMonth = hasOfftakeBefore ? 12 : monthsSet.size;

				let sum = relatedOfftakes.map(offtake => offtake.ASI_CRM_Converted_Qty_9L__c).reduce(reducer, 0);

				detail.ASI_CRM_P12M_Avg_Consumption_9L__c = numOfMonth === 0 ? 0 : sum / numOfMonth;

			})
			addOutletComplete_final(addedPromotionDetailList, outletName);
        }
		
		function addOutletComplete_final(addedPromotionDetailList, outletName){
			// update DOM
			var sectionId = PROMOTION_CUSTOMER_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
			var tableId = PROMOTION_DETAIL_TABLE_PREFIX + NEW_PROMOTION_TABLE_ID_INDEX;
			var parentOutletName = CUSTOMER_MAP[outletName].ASI_CRM_CN_Parent_Outlet__r != null ? PARENT + CUSTOMER_MAP[outletName].ASI_CRM_CN_Parent_Outlet__r.Name : '';
			var promotionDetailBody = OUTLET_PANEL_HTML.f(sectionId, outletName, sectionId, tableId, parentOutletName);
			$("#promotionEnrollmentForm").append(promotionDetailBody);
			setNewTableConfig(tableId, addedPromotionDetailList);
			NEW_PROMOTION_TABLE_ID_INDEX ++;
			
			$("body").removeClass("savingRecord");
            preventNagativeNumber();
		}

        
        function updatePromotionDetailValue(row, fieldName, newValue) {
            /*
			for(var i = 1 ; i < NEW_PROMOTION_TABLE_ID_INDEX; i++) {
                var tableId = PROMOTION_DETAIL_TABLE_PREFIX + i;
            	if($("#" + tableId)) {
                	var promotionDetailData = $("#" + tableId).DataTable().row(row).data();
                    promotionDetailData[fieldName] = newValue;
                }
            }
			*/
			var promotionDetailData = $(row).closest("table").DataTable().row(row).data();
			promotionDetailData[fieldName] = newValue;
			$(row).closest("table").DataTable().rows().invalidate('data').draw(false);
        }
        
        function deleteOutlet(outletName) {
            var tableId = $("#" + outletName).find("table").attr("id");
			console.log(tableId);
            var promotionDetailData = $('#'+tableId).DataTable().rows().data();
			console.log(promotionDetailData);
            for(var i = 0 ; i < promotionDetailData.length ; i++) {
                if(promotionDetailData[i].Id.startsWith(NEW_PROMOTION_DETAIL_PREFIX)) continue;
                
                deletePromotionDetailIdList.push(promotionDetailData[i].Id);
            }
			var customerName = $("#" + outletName + " > div.panel-heading > div.container > div.outletName").text();
			CUSTOMER_LIST.push(customerName);
        	$("#" + outletName).remove();
        }
        
        function validatePromotionEnrollment(promotionDetailDataList) {
            var errorMessage;
            
            for(var index = 0 ; index < promotionDetailDataList.length ; index++) {
            	var promotionDetail = promotionDetailDataList[index];
                
                if(!promotionDetail.ASI_CRM_Target_Qty_Bottle__c || promotionDetail.ASI_CRM_Target_Qty_Bottle__c == 0) {
                	if(!errorMessage)
                        errorMessage = "Missing required field [Target Qty (Bottle)] ";
                }
            }
            
            return errorMessage;
        }
        
        function saveRecord(isQuickSave) {
           	$("#warningPanel").hide();
            var upsertPromotionDetailList = [];
            
            for(var j = 1 ; j < NEW_PROMOTION_TABLE_ID_INDEX; j++) {
                var tableId = PROMOTION_DETAIL_TABLE_PREFIX + j;
            	if($("#" + tableId)) {
                	var promotionDetailData = $("#" + tableId).DataTable().rows().data();
                    var errorMessage = validatePromotionEnrollment(promotionDetailData);
                    if(errorMessage) {
                        $("#warningPanel").show();
               		 	$("#warningMessage").html(errorMessage);
                    	return;
                    }
                    for(var i = 0 ; i < promotionDetailData.data().length ; i++) {
                        var clonedPromotionPlan = jQuery.extend({}, promotionDetailData[i]);
                        if(clonedPromotionPlan.Id.startsWith(NEW_PROMOTION_DETAIL_PREFIX)) {
                            delete clonedPromotionPlan["Id"];
                        }
                        delete clonedPromotionPlan.ASI_CRM_Promotion_Mechanic__r;
                        //console.log(clonedPromotionPlan);
                        upsertPromotionDetailList.push(clonedPromotionPlan);
                    }
                }
            }
            
            $("body").addClass("savingRecord");
            savePromotionDetail(isQuickSave, JSON.stringify(upsertPromotionDetailList), JSON.stringify(deletePromotionDetailIdList));
        }
        
        function saveRecordComplete(promotionDetailListJson) {
            $("body").removeClass("savingRecord");
			setTable(promotionDetailListJson);
        }
        
        function setNewTableConfig(tableId, promotionDetailList) {
            var dataTableProperties = CONST_DATA_TABLE_PROPERTIES;
            dataTableProperties["aaData"] = promotionDetailList;
            dataTableProperties["rowId"]  = "Id";
                
            var columns = [];
            columns.push(FIELD_CONFIG_MAPPING.mechanics);
			/*
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Promotional_SKU__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Promotional_Sub_brand__c);
			*/
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Target_Qty_Bottle__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Target_Volume_9L__c);
			columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Monthly_Avg_Target_Volume_9L__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_P12M_Avg_Consumption_9L__c);
			/*
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Buy_Qty__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Buy_Unit__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Trade_Deal_Bottle_Qty__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Additional_SKU_POSM__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Additional_SKU_Bottle_Qty__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Ad_hoc_Cash__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Gift_Voucher__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Other_in_Kind_Cash__c);
            columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_Remark__c);
			*/
			if(IS_FINAL_APPROVED) columns.push(FIELD_CONFIG_MAPPING.ASI_CRM_ActualConsumption_9L__c);
           	dataTableProperties["aoColumns"] = columns;
                
            $("#" + tableId).dataTable(dataTableProperties);
        }
        
        function preventNagativeNumber() {
        	$(".numberField").keydown(function(e) {
                if(!((e.keyCode > 95 && e.keyCode < 106)
                  || (e.keyCode > 47 && e.keyCode < 58) 
                  || e.keyCode == 8)) {
                    return false;
                }
            });
        }
    </script>
    
    <body>
        <div class="fullScreenLoading"></div>
        
        <div id="warningPanel" class="panel panel-danger">
       		<div class="panel-heading">Warning!</div>
        	<div id="warningMessage" class="panel-body"></div>
        </div>
        
        <!-- Define Action Function -->
        <apex:form >
            <apex:actionFunction name="savePromotionDetail" action="{!savePromotionDetail}" reRender="pageMsg" 
                                 onComplete="saveRecordComplete('{!JSENCODE(promotionDetailListJson)}');">
                <apex:param name="isQuickSave" value="" />
                <apex:param name="upsertPromotionDetailListJson" value="" />
                <apex:param name="deletePromotionDetailIdListJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="getAllRelatedOfftakes" action="{!getAllRelatedOfftakes}" reRender="pageMsg" 
                                 onComplete="addOutletComplete_offtake('{!JSENCODE(addedPromotionDetailListJson)}', '{!returnCustomerName}', '{!JSENCODE(P12MConsumption_offtakeJson)}');">
                <apex:param name="customerName" value="" />
                <apex:param name="skuIds" value="" />
                <apex:param name="subBrandIds" value="" />
                <apex:param name="mechanicsJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="getAllRelatedSalesOrderHistories" action="{!getAllRelatedSalesOrderHistories}" reRender="pageMsg" 
                                 onComplete="addOutletComplete_SOH('{!JSENCODE(addedPromotionDetailListJson)}', '{!returnCustomerName}', '{!JSENCODE(P12MConsumption_SOHJson)}');">
                <apex:param name="customerName" value="" />
                <apex:param name="skuIds" value="" />
                <apex:param name="subBrandIds" value="" />
                <apex:param name="mechanicsJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="cancel" action="{!cancel}"/>
        </apex:form>
        
        <!-- Body -->
        <apex:pageBlock id="detail_pageBlock">
            <apex:pageblockButtons >
                <input type="button" class="btn saveBtn" onclick="saveRecord(false)" value="Save" />
                <input type="button" class="btn quickSaveBtn" onclick="saveRecord(true)" value="Quick Save" />
                <input type="button" class="btn cancelBtn" onclick="cancel()" value="Cancel" />
            </apex:pageblockButtons>
            
            <!-- Nav bar -->
            <div class="row">
                <div class="container-fluid">
                    <div class="panel with-nav-tabs panel-primary">
                        <!-- Nav bar header -->
                        <div class="panel-heading">
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="#promotionEnrollmentPanel" data-toggle="tab">Promotion Enrollment</a></li>
                            </ul>
                        </div>
    
                        <!-- Nav bar body -->
                        <div class="panel-body">
                            <div class="tab-content">
                                <!-- Promotion Mechanic Panel -->
                                <div class="tab-pane fade in active" id="promotionEnrollmentPanel">
                                    <form id="promotionEnrollmentForm">
                                        <input type="text" id="addOutletName" class="form-control" placeholder="Input Customer name here" />
                                        <!--
										<input type="button" class="btn" onclick="addOutlet()" value="Add Outlet" />
										-->
                                        <br />
                                        <br />
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </apex:pageBlock>
    </body>
    
</apex:page>